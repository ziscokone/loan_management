<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="view_reversement_form" model="ir.ui.view">
        <field name="name">reversement.form</field>
        <field name="model">reversement</field>
        <field name="arch" type="xml">
            <form class="o_form_view">
                <header class="bg-white border-bottom">
                    <button name="action_validate" 
                            string="Valider" 
                            type="object" 
                            class="btn btn-success px-4 me-2" 
                            invisible="state == 'validated'"
                            icon="fa-check"
                            confirm="Êtes-vous sûr de vouloir valider ce reversement ?"/>
                    
                    <field name="state" widget="statusbar" statusbar_visible="draft,validated" invisible="1"/>
                </header>

                <div class="p-0">
                    <div class="position-relative rounded-3 bg-white shadow-sm mx-4 my-3">
                        <!-- Messages d'alerte stylisés -->
                        <div class="p-3">
                            <div class="alert alert-info rounded-3 text-center border-0 shadow-sm mb-0" role="alert" invisible="state != 'draft'">
                                <i class="fa fa-info-circle fa-lg me-2"/> Complétez tous les champs requis avant de valider le Prélèvement.
                            </div>
                            <div class="alert alert-success rounded-3 text-center border-0 shadow-sm mb-0" role="alert" invisible="state != 'validated'">
                                <i class="fa fa-check-circle fa-lg me-2"/> Ce Prélèvement a été validé avec succès !
                            </div>
                        </div>

                        <!-- Contenu principal -->
                        <div class="p-4">
                            <div class="row g-4">
                                <!-- Informations du reversement -->
                                <div class="col-12">
                                    <div class="p-2 rounded-3 border bg-light">
                                        <h4 class="mb-4 d-flex align-items-center text-primary">
                                            <i class="fa fa-money me-2"/>
                                            <span>Informations du Reversement</span>
                                        </h4>
                                        <group>
                                            <group>
                                                <field name="campagne_id" 
                                                       readonly="state == 'validated'"/>
                                                <field name="mois" 
                                                       readonly="state == 'validated'"/>
                                                <field name="date" 
                                                       readonly="state == 'validated'"/>
                                            </group>
                                            <group>
                                                <field name="fichier_excel" 
                                                       readonly="state == 'validated'"/>
                                                <field name="nom_fichier" 
                                                       readonly="state == 'validated'" 
                                                       invisible="1"/>
                                                <field name="total_montant" 
                                                       readonly="1"
                                                       class="text-success fw-bold"/>
                                            </group>
                                        </group>
                                    </div>
                                </div>

                                <!-- Lignes de reversement -->
                                <div class="col-12">
                                    <div class="bg-light p-2">
                                        <h4 class="mb-2 d-flex align-items-center text-primary">
                                            <i class="fa fa-list me-2"/>
                                            <span>Détails des Versements</span>
                                        </h4>
                                        <div class="border bg-white rounded-3 shadow-sm">
                                            <field name="ligne_ids" readonly="state == 'validated'" class="table-responsive">
                                                <tree editable="bottom"  create="0" delete="0" edit="0" class="table-sm" decoration-success="montant_paye > 0">
                                                    <field name="employee_id" required="1"/>
                                                    <field name="nom"/>
                                                    <field name="prenoms"/>
                                                    <field name="montant_paye" options="{'text_align': 'center'}"/>                                                    
                                                    <field name="loan_application_id" domain="[('employee_id', '=', employee_id)]"/>
                                                </tree>
                                            </field>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chatter -->
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Vue Liste -->
    <record id="view_reversement_tree" model="ir.ui.view">
        <field name="name">reversement.tree</field>
        <field name="model">reversement</field>
        <field name="arch" type="xml">
            <tree decoration-muted="state == 'draft'"
                  decoration-success="state == 'validated'">
                <field name="campagne_id"/>
                <field name="mois"/>
                <field name="total_montant"/>
                <field name="date"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'validated'"/>
            </tree>
        </field>
    </record>

    <!-- Vue Recherche -->
    <record id="view_reversement_search" model="ir.ui.view">
        <field name="name">reversement.search</field>
        <field name="model">reversement</field>
        <field name="arch" type="xml">
            <search>
                <field name="date"/>
                <field name="campagne_id"/>
                <separator/>
                <filter string="Brouillon" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Validé" name="validated" domain="[('state', '=', 'validated')]"/>
                <group expand="0" string="Regrouper Par">
                    <filter string="Campagne" name="group_by_campaign" context="{'group_by': 'campagne_id'}"/>
                    <filter string="Date" name="group_by_date" context="{'group_by': 'date:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_reversement" model="ir.actions.act_window">
        <field name="name">Prélèvement</field>
        <field name="res_model">reversement</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_reversement_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créer votre premier Prélèvement
            </p>
            <p>
                Importez un fichier Excel contenant les paiements des employés.
                <br/>
                <i class="fa fa-arrow-right"/> Cliquez sur 'Créer' pour démarrer.
            </p>
        </field>
    </record>

    <!-- Menu Items -->
    <menuitem id="menu_reversement_main" 
              name="Suivis"
              parent="loan_management.menu_loan_root"
              action="action_reversement"
              sequence="10"/>
</odoo>