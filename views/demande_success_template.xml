<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="loan_result" name="Loan Application Result">
        <t t-call="website.layout">
            <style>
                .page-background {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)),
                                url('/loan_management/static/src/img/paa2.png') center/cover no-repeat;
                    filter: blur(2px);
                    z-index: -1;
                }

                .result-card {
                    background: rgba(255, 255, 255, 0.98);
                    backdrop-filter: blur(5px);
                }

                .success-icon {
                    animation: pulse 2s infinite;
                }

                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                    100% { transform: scale(1); }
                }

                .detail-card {
                    background: rgba(248, 249, 250, 0.9) !important;
                }
            </style>

            <script type="text/javascript">
                function logDownload(reference) {
                    console.log('Téléchargement du document avec la référence:', reference);
                    
                    // Créer une nouvelle fenêtre pour l'impression
                    const printWindow = window.open('', '', 'width=800,height=600');
                    
                    // Ajouter les styles améliorés
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Récapitulatif de demande - ${reference}</title>
                            <style>
                                body {
                                    font-family: 'Arial', sans-serif;
                                    padding: 30px;
                                    background: #f4f4f4;
                                    color: #333;
                                }
                                .container {
                                    max-width: 800px;
                                    margin: 0 auto;
                                    background: #fff;
                                    padding: 20px;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                                }
                                .detail-card {
                                    padding: 20px;
                                    border-radius: 8px;
                                    background: #f8f9fa;
                                    border-left: 5px solid #007bff;
                                }
                                .row {
                                    display: flex;
                                    justify-content: space-between;
                                    margin-bottom: 15px;
                                }
                                .col-lg-4, .col-lg-8 {
                                    flex: 1;
                                    padding: 10px;
                                }
                                .col-lg-4 {
                                    font-weight: bold;
                                    color: #007bff;
                                }
                                .card-title {
                                    font-size: 1.5rem;
                                    font-weight: bold;
                                    margin-bottom: 20px;
                                    text-align: center;
                                    color: #007bff;
                                }
                                .separator {
                                    border-bottom: 2px solid #ddd;
                                    margin: 15px 0;
                                }
                                .footer {
                                    text-align: center;
                                    font-size: 0.9rem;
                                    margin-top: 20px;
                                    color: #666;
                                }
                                @media print {
                                    body {
                                        padding: 0;
                                        background: none;
                                    }
                                    .container {
                                        box-shadow: none;
                                        border: none;
                                    }
                                    .footer {
                                        display: none;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h2 class="card-title">Récapitulatif de la demande</h2>
                    `);
                    
                    // Récupérer uniquement le contenu de la carte récapitulative
                    const cardContent = document.querySelector('.detail-card').cloneNode(true);
                    
                    // Supprimer le bouton de téléchargement
                    const downloadButton = cardContent.querySelector('.position-absolute');
                    if (downloadButton) {
                        downloadButton.remove();
                    }
                    
                    // Ajouter le contenu mis en forme
                    printWindow.document.write(cardContent.outerHTML);
                    printWindow.document.write(`
                                <div class="separator"></div>
                                <p class="footer">Imprimé automatiquement - ${new Date().toLocaleDateString()}</p>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    // Fermer le document
                    printWindow.document.close();
                    
                    // Attendre que le contenu soit chargé avant d'imprimer
                    printWindow.onload = function() {
                        printWindow.print();
                        printWindow.onafterprint = function() {
                            printWindow.close();
                        };
                    };
                    
                    return false;
                }

            </script>

            <!-- Background avec image floutée -->
            <div class="page-background"></div>

            <!-- Contenu principal -->
            <div class="container py-4 position-relative">
                <div class="row justify-content-center">
                    <div class="col-md-7">
                        <div class="card shadow-lg border-0 result-card" id="cardRecapDemande">
                            <div class="card-body text-center p-3">
                                <t t-if="success">
                                    <!-- Icône de succès avec animation -->
                                    <div class="mb-4 success-icon">
                                        <i class="fa fa-check-circle text-success" style="font-size: 4rem;"></i>
                                    </div>

                                    <!-- Message de succès dynamique -->
                                    <h4 class="mb-4">
                                        <t t-if="is_update">Demande Mise à Jour avec Succès!</t>
                                        <t t-else="">Demande Soumise avec Succès!</t>
                                    </h4>
                                    
                                    <!-- Détails de la demande -->
                                    <div class="card detail-card mb-4 position-relative">
                                                <!-- Bouton de téléchargement -->
                                        <div class="position-absolute top-0 end-0 m-3">
                                            <a href="#" 
                                            t-att-onclick="'logDownload(\'' + reference + '\'); return false;'"
                                            class="btn btn-outline-primary btn-sm rounded-circle" 
                                            title="Télécharger le récapitulatif">
                                                <i class="fa fa-download"></i>
                                            </a>
                                        </div>

                                        <div class="card-body">
                                            <h5 class="card-title mb-3">
                                                <t t-if="is_update">Récapitulatif de votre demande mise à jour</t>
                                                <t t-else="">Récapitulatif de votre demande</t>
                                            </h5>
                                            <div class="row mb-2">
                                                <div class="col-lg-4 text-start"><strong>Référence:</strong></div>
                                                <div class="col-lg-8 text-start"><t t-esc="reference"/></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-lg-4 text-start"><strong>Matricule:</strong></div>
                                                <div class="col-lg-8 text-start"><t t-esc="matricule"/></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-lg-4 text-start"><strong>Nom:</strong></div>
                                                <div class="col-lg-8 text-start"><t t-esc="nom"/></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-lg-4 text-start"><strong>Prénoms:</strong></div>
                                                <div class="col-lg-8 text-start"><t t-esc="prenoms"/></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-lg-4 text-start"><strong>Sexe:</strong></div>
                                                <div class="col-lg-8 text-start"><t t-esc="sexe"/></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-lg-4 text-start"><strong>Direction:</strong></div>
                                                <div class="col-lg-8 text-start"><t t-esc="direction"/></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-lg-4 text-start"><strong>Montant demandé:</strong></div>
                                                <div class="col-lg-8 text-start">
                                                    <span t-esc="'{:,.0f}'.format(float(amount_requested)).replace(',', ' ')"/> FCFA
                                                </div>
                                            </div>
                                                <div class="row mb-2">
                                                <div class="col-lg-4 text-start"><strong>Mensualité:</strong></div>
                                                <div class="col-lg-8 text-start">
                                                    <span t-esc="'{:,.0f}'.format(mensualite).replace(',', ' ')"/> FCFA
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Message d'information dynamique -->
                                    <p class="text-muted mb-4">
                                        <t t-if="is_update">
                                            Votre demande a été mise à jour avec succès et sera retraitée dans les plus brefs délais.
                                            Vous serez notifié(e) de l'avancement de votre dossier.
                                        </t>
                                        <t t-else="">
                                            Votre demande a été enregistrée et sera traitée dans les plus brefs délais.
                                            Vous serez notifié(e) de l'avancement de votre dossier.
                                        </t>
                                    </p>
                                </t>

                                <t t-if="error">
                                    <!-- Section d'erreur stylisée et compacte -->
                                    <div class="mb-4 d-flex justify-content-center">
                                        <i class="fa fa-exclamation-circle text-danger" style="font-size: 2.5rem;"></i>
                                    </div>

                                    <!-- Message d'erreur compact et centré -->
                                    <h5 class="mb-3 text-danger">Une erreur est survenue</h5>
                                    <div class="alert alert-danger py-2 mx-auto" style="max-width: 80%;">
                                        <p class="mb-0 small" t-esc="message"/>
                                    </div>
                                </t>

                                <!-- Boutons d'action avec hover effect -->
                                <div class="mt-4">
                                    <a href="/matricule" class="btn btn-primary me-2 px-4 py-2 shadow-sm hover-lift" style="background-color:#0099CC">
                                        <i class="fa fa-plus-circle me-2"></i>Nouvelle Demande
                                    </a>
                                    <a href="/" class="btn btn-secondary px-4 py-2 shadow-sm hover-lift">
                                        <i class="fa fa-home me-2"></i>Retour à l'Accueil
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>